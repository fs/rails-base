#!/usr/bin/env ruby

require 'fileutils'

class BootstrapCi
  def initialize(argv)
    @argv = argv
  end

  def run
    install
  end

  private

  def install
    setup_database_yml
    setup_dotenv
    install_gems
    migrate_db
  end

  def setup_database_yml
    setup_file_from_template('config/database.yml')
  end

  def setup_dotenv
    setup_file_from_template('.env')
  end

  def install_gems
    system_with_note("bundle install --path vendor/bundle --without production staging development")
  end

  def migrate_db
    system_with_note('bundle exec rake db:setup')
    system_with_note('bundle exec rake db:test:prepare')
  end


  def setup_file_from_template(file)
    unless File.exists?(File.join(rails_root, file))
      puts "#{file} is missing, installing..."
      FileUtils.cp(File.join(rails_root, "#{file}.example"), File.join(rails_root, file))
    end
  end

  def rails_root
    @rails_root ||= File.expand_path('../../', __FILE__)
  end

  def system_with_note(command)
    puts "Running #{command} ..."
    result = system(command) || exit(1)
    puts "\n\n"

    result
  end
end


BootstrapCi.new(ARGV).run
